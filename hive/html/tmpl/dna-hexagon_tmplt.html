<script>
    $.loadLayoutManager();
    $.loadCSS('css/look_and_feel/velvet.css');
    $.loadCSS('css/algoview.css');
    $.loadScript('jsx/widgets/jquery/view/jquery.algoview.js');
    $.loadCSS('css/tabs.css');
</script>

<div style="text-align:center;font-size:20px;font-weight:bold;visibility:hidden;" id="jumpNewPage">
    <a href="#">
        Click to go to old Aligner webpage
    </a>
</div>

<script>
    document.write(algoViewHTMLSetUp(false));
</script>

<script src="js-obj-new/svc-alignment.js"></script>
<script src="js-obj-new/svc-alignment-multiple.js"></script>
<script src="js-obj-new/svc-align-blastx.js"></script>


<script type="application/javascript">

    google.load("visualization", "1", { packages: ["corechart"] });

    var valgoToolbarDoneList = [
        {
            type: '',
            align: 'right',
            order: '2',
            name: 'tools',
            title: 'Profiling Tools',
            icon: 'img-algo/dna-tools.gif',
            path: '/profiler',
            url: '',
            description: 'Reference based assembly and profiling analysis'
        },
        {
            type: '',
            align: 'right',
            order: '2',
            name: 'profiler',
            title: 'Sequence Profiling',
            icon: 'img-algo/svc-profiler.gif',
            path: '/profiler/profiler',
            url: '?cmd=dna-heptagon&parent_proc_ids=$(::thisProcessID)',
            description: 'Proceed to sequence profiling analysis: basecalling, SNP computations, etc...'
        },
        {
            type: '',
            align: 'right',
            order: '3',
            name: 'recombinant',
            title: 'Reference Recombination',
            icon: 'img-algo/svc-recomb.gif',
            path: '/profiler/recombinant',
            url: '?cmd=dna-recomb&parent_proc_ids=$(::thisProcessID)',
            description: 'Proceed to sequence recombination discovery analysis'
        },
        {
            type: '',
            align: 'right',
            order: '3.5',
            name: 'diprofiler',
            title: 'DVG Profiling',
            icon: 'img-algo/svc-diprofiler.gif',
            path: '/profiler/diprofiler',
            url: '?cmd=dna-diprofiler&parent_proc_ids=$(::thisProcessID)',
            description: 'Proceed to Defective Viral Genomes detection'
        },
        {
            type: '',
            align: 'right',
            order: '4',
            name: 'populator',
            title: 'Population Analysis',
            icon: 'img-algo/hive-population.gif',
            path: '/profiler/population',
            url: '?cmd=dna-popul&parent_proc_ids=$(::thisProcessID)',
            description: 'Proceed to population analysis computations'
        },
        // {
        //     type: '',
        //     align: 'right',
        //     order: '5',
        //     name: 'samtools',
        //     title: 'Samtools SNP Calling',
        //     icon: 'img-algo/svc-profx-samtools.gif',
        //     path: '/profiler/profx',
        //     url: '?cmd=dna-profiler&cmdMode=profx&svc-profx-samtools=1&parent_proc_ids=$(::thisProcessID)',
        //     description: 'Proceed to samtools sequence profiling analysis: basecalling, SNP computations, etc...'
        // },
        {
            type: '',
            align: 'right',
            order: '6',
            name: 'dnatargetQC',
            title: 'Targeted Alignment QC',
            icon: 'img-algo/svc-diprofiler.gif',
            path: '/profiler/diprofiler',
            url: '?cmd=dna-targetQC&parent_proc_ids=$(::thisProcessID)',
            description: 'Proceed to Targeted Alignment QC'
        }
    ]

    var thisProcessID = docLocValue("id"); if (!thisProcessID) thisProcessID = 0;
    var process_svc = "svc-align-hexagon2";
    var process_qpsvc = "dna-hexagon";
    var thisQuery = docLocValue("query");

    var algoProcess = new valgoProcess(thisProcessID, process_qpsvc, process_svc, "svc-align-hexagon");

    algoProcess.visibleParameters = ["name", "alignSelector", "query", "query_paired", "subject", "minMatch", "keepAllMatches", "mismatches"];
    algoProcess.submitButtonName = "ALIGN";
    algoProcess.docLocsToBorrow = ["id", "query"];
    /* //Can do this if need to special customize different areas (can add with this)
    vjDS.add("", "dsHelpAdvanced", "http://help/hlp.obj.svc-align-hexagon.advanced.html");
    algoProcess.tabsToAdd = [{whereToAdd: "right", visibleDuring: ["computed"], pageTabName:"blah", whatToAdd: {
        tabId: 'advHelp',
        tabName: "Advanced Parameters Help",
        inactive: true,
        position: {posId: 'layout_inputs', top:'0', bottom:'50%', left:'20%', right:'75%'},
        viewerConstructor: {
            dataViewer: 'vjHelpView',
            dataViewerOptions: {
                data: "dsHelpAdvanced"
            }
        },
        autoOpen: ["preSubmit"]
    }}];  */

    algoProcess.help.push({ name: "Advanced Parameters Help", url: "http://help/hlp.obj.svc-align-hexagon.advanced.html" });


    var toolName = docLocValue("cmdMode");
    var toolVersion = docLocValue("version");
    var modeIndex = toolName.indexOf("-");
    if (toolName.indexOf("dna-") == 0) {
        toolName = toolName.substring(3);
        modeIndex = toolName.indexOf("-");
    }
    toolName = toolName.substring(0, modeIndex < 0 ? toolName.length : modeIndex);
    if (toolName == "") {
        toolName = "hexagon";
    }

    var isDsReloaded = false;
    var isMultipleAlignment = false;
    var algoTitle = "Hexagon Aligner v2.1";

    vjDS.add("", "dsTools", "static://");
    vjDS.dsTools.register_callback(function (viewer, data) {
        var toolJson = JSON.parse(data);
        var latestTool;

        while (!latestTool) {
            for (var i in toolJson.objs) {
                var obj = toolJson.objs[i];
                if (obj.name === toolName) {
                    if (!toolVersion) {
                        latestTool = obj;
                        break;
                    }
                    else if (obj.version === toolVersion) {
                        latestTool = obj;
                        break;
                    }
                }
            }
            if (!latestTool) {
                toolName = "hexagon";
            }
        }
        algoProcess.initialPresets = {
            alignSelector: latestTool._id
        };
        algoProcess.svcRecViewer = latestTool.type_name;

        if (algoProcess.isMode("hexagon") && algoProcess.cmdMode) {
            algoProcess.visibleParameters.push("maxMissQueryPercent");
        } else if (algoProcess.isMode("blast")) {
            algoProcess.visibleParameters = ["name", "alignSelector", "query", "subject", "minMatch", "keepAllMatches"];
            if (algoProcess.isMode("blastx")) {
                algoTitle = "Blastx Aligner";
                algoProcess.qpSvc = "dna-alignx-blastx";
                algoProcess.svcProcType = "svc-align-blastx2";
            } else {
                algoTitle = "Blast Aligner";
                algoProcess.svcProcType = "svc-align-blast2";
                algoProcess.qpSvc = "dna-alignx-blast";
            }
        } else if (algoProcess.isMode("tblastx")) {
            algoTitle = "TBlastX Aligner";
            algoProcess.visibleParameters = ["name", "alignSelector", "query", "subject", "evalueFilter", "output_fmt", "maxHitsPerRead", "wordSize", "max_intron_length"];
            algoProcess.svcProcType = "svc-align-tblastx2";
            algoProcess.qpSvc = "dna-alignx-tblastx";
        } else if (algoProcess.isMode("blat")) {
            algoTitle = "Blat Aligner";
            algoProcess.visibleParameters = ["name", "alignSelector", "query", "subject", "seedSize", "minMatch", "maxMissQueryPercent"];
            algoProcess.svcProcType = "svc-align-blat2";
            algoProcess.qpSvc = "dna-alignx-blat";
        } else if (algoProcess.isMode("bwa")) {
            algoTitle = "BWA Aligner";
            algoProcess.visibleParameters = ["name", "alignSelector", "query", "subject", "seedSize", "minMatch", "maxMissQueryPercent"];
            algoProcess.svcProcType = "svc-align-bwa2";
            algoProcess.qpSvc = "dna-alignx-bwa";
        } else if (algoProcess.isMode("bowtie2")) {
            algoTitle = "Bowtie2 Aligner";
            algoProcess.svcProcType = "svc-align-bowtie2";
            algoProcess.qpSvc = "dna-alignx-bowtie2";
        } else if (algoProcess.isMode("bowtie")) {
            algoTitle = "Bowtie Aligner";
            algoProcess.svcProcType = "svc-align-bowtie1";
            algoProcess.qpSvc = "dna-alignx-bowtie";
        } else if (algoProcess.isMode("tophat")) {
            algoTitle = "Tophat Aligner";
            algoProcess.svcProcType = "svc-align-tophat2";
            algoProcess.qpSvc = "dna-alignx-tophat";
            algoProcess.visibleParameters = ["name", "alignSelector", "query", "subject", "GTFfile", "minMatch", "keepAllMatches", "maxMissQueryPercent", "GTFfile"];
            let hascuffdiff = false
            let i
            while (valgoToolbarDoneList[i] && !hascuffdiff) {
                if (valgoToolbarDoneList[i].name === 'cuffdiff') hascuffdiff = true;
                i++
            }
            if (!hascuffdiff) {
                var tmp = [
                    {
                        type: '',
                        align: 'right',
                        order: '6',
                        name: 'cuffdiff',
                        title: 'Cuffdiff Differential Expression',
                        icon: 'img-algo/svc-profx-cuffdiff.gif',
                        path: '/profiler/cuffdiff',
                        url: '?cmd=dna-cuffDiff&parent_proc_ids=$(::thisProcessID)',
                        description: 'Proceed to differential expression analysis'
                    }
                ]
                valgoToolbarDoneList.concat(tmp)
            }
        } else if (algoProcess.isMode("hisat2")) {
            algoTitle = "HISAT2 Aligner";
            algoProcess.svcProcType = "svc-align-hisat2";
            algoProcess.qpSvc = "dna-alignx-hisat2";
            algoProcess.visibleParameters = ["name", "alignSelector", "query", "query_paired", "subject", "gtf_params", "minMatch", "keepAllMatches", "maxMissQueryPercent"];
        } else if (algoProcess.isMode("clustal")) {
            algoTitle = "Clustal Aligner";
            algoProcess.svcProcType = "svc-align-clustal2";
            algoProcess.qpSvc = "dna-alignx-clustal";
            algoProcess.field_visibility = { query: 'hidden' };
            isMultipleAlignment = true;
        } else if (algoProcess.isMode("mafft")) {
            algoTitle = "MAFFT Aligner";
            algoProcess.svcProcType = "svc-align-mafft2";
            algoProcess.qpSvc = "dna-alignx-mafft";
            isMultipleAlignment = true;
        }

        if (!(thisProcessID + "").indexOf("-") == 0) {
            if (isMultipleAlignment) {
                algoProcess.fields = { query: { is_hidden_fg: 1 } };
                algoProcess.visibleParameters = ["parsed", "name", "alignSelector", "subject"];
            }
            algoProcess.initialPresets.name = "";
            if (algoProcess.isMode("virus")) {
                algoProcess.help.push({ name: "Viral Genome", url: "http://help/hlp.page.dna-hexagon.virus.html" });
                algoProcess.visualImage = "img-subject/viruses-original.jpg";

                algoProcess.initialPresets.name += " Virus";
                algoProcess.initialPresets.seed = 11;
            }
            else if (algoProcess.isMode("bacteria")) {
                algoProcess.help.push({ name: "Bacteria", url: "http://help/hlp.page.dna-hexagon.bacteria.html" });
                algoProcess.visualImage = "img-subject/bacteria.png";

                algoProcess.initialPresets.name += " Bacteria";
                algoProcess.initialPresets.seed = 12;

                algoProcess.visibleParameters.push("searchRepeatsAndTrans");
            }
            else if (algoProcess.isMode("human")) {
                algoProcess.help.push({ name: "Human Subject", url: "http://help/hlp.page.dna-hexagon.HumanWGS.html" });
                algoProcess.visualImage = "img-subject/HumanWGS.jpg";

                algoProcess.initialPresets.name += " Homo sapiens";
                algoProcess.initialPresets.seed = 14;
                algoProcess.initialPresets.looseExtenderMismatchesPercent = 15;
                algoProcess.initialPresets.hashCompileStp = 2;
                algoProcess.initialPresets.maxMissQueryPercent = 3;
                algoProcess.initialPresets.maxHitsPerRead = 50;

                if (algoProcess.isMode("wgs")) {
                    algoProcess.initialPresets.maxHashBin = 50;
                }
            }
            else if (algoProcess.isMode("related")) {
                algoProcess.visualImage = "img-subject/viruses-original.jpg";

                algoProcess.initialPresets.name += " Distant Relative";
                algoProcess.initialPresets.seed = 8;
                algoProcess.initialPresets.selfQueryPosJumpInNonPerfectAlignment = 0;
                algoProcess.initialPresets.maxExtensionGaps = 2;
                algoProcess.initialPresets.looseExtenderMismatchesPercent = 23;
                algoProcess.initialPresets.maxMissQueryPercent = 20;
                algoProcess.initialPresets.minMatchLen = 36;
            }

            if (algoProcess.isMode("wgs")) {
                algoProcess.help.push({ name: "Whole Genome Sequencing", url: "http://help/hlp.page.hive-hexagon.WGS.html", icon: "dna" });

                algoProcess.initialPresets.subject = "query:alloftype(\"genome\",{taxonomy:\"human-genome\"})";
                algoProcess.initialPresets.name += " Whole Genome Sequencing";
                algoProcess.initialPresets.alignmentEngine = 0;
                algoProcess.initialPresets.keepAllMatches = 0;
            } if (algoProcess.isMode("exome")) {
                algoProcess.help.push({ name: "Exome", url: "http://help/hlp.page.dna-hexagon.exome.html" });

                algoProcess.initialPresets.name += " Exome Sequencing";
                algoProcess.initialPresets.subject = "query:alloftype(\"genome\",{taxonomy:\"human-exome\"})";
            }
            if (algoProcess.isMode("transcriptome")) {
                algoProcess.help.push({ name: "Transcriptome", url: "http://help/hlp.page.dna-hexagon.transcriptome.html" });

                algoProcess.initialPresets.name = " Transcriptome Sequencing";
                algoProcess.initialPresets.subject = "query:alloftype(\"genome\",{taxonomy:\"human-transcriptome\"})";
            }
        }

        isDsReloaded = true;
    });
    vjDS.dsTools.reload("http://?cmd=objList&type=algorithm-alignment%2B&raw=1&mode=json", true);

    algoProcess.inputLoaded = function (viewer, elem) {
        algoProcess.readFromDocLoc(["query", "subject", "referenceAnnot", "keepAllMatches", "doubleStagePerfect"]);
        var qry = algoProcess.getValue("query");
        var sub = algoProcess.getValue("subject");


        var okToSubmit = isok(qry) && isok(sub) && algoProcess.modeActive;
        if (isMultipleAlignment) {
            okToSubmit = isok(sub) && algoProcess.modeActive;
        }
        algoProcess.activateSubmitButton(okToSubmit);

        if (thisProcessID && thisProcessID.indexOf("-") == 0)
            $("[title='Alignment engine selector']").find("button").remove();
    }

    algoProcess.inputChanged = function (viewer, elem, node) {
        // toggle automatic naming capability based on current typed name
        var isAllowNameChange = true;
        if (elem.name.indexOf(".name") > 0) {
            isAllowNameChange = algoProcess.getValue("name") ? false : true;
        }

        var qry = algoProcess.getValue("query", "join");
        var sub = algoProcess.getValue("subject", "join");

        if (isAllowNameChange && (elem.name.indexOf(".subject") > 0) || (elem.name.indexOf(".query") > 0)) {
            if (isMultipleAlignment && isok(sub)) {
                let sub1 = '"' + sub.replace(/,/g, '","') + '"';
                algoProcess.setValueList({ name: "query:s=[" + sub1 + "] as objlist; cnt=((int)s)-1; a=s[0].name; if(cnt>0){ a=cat( a,\" and \", cnt, \" more\");} return a;" });
            } else if ((isok(qry) && isok(sub))) {
                let sub1 = '"' + sub.replace(/,/g, '","') + '"';
                let qry1 = '"' + qry.replace(/,/g, '","') + '"';
                algoProcess.setValueList({ name: "query:q=[" + qry1 + "] as objlist;s=[" + sub1 + "] as objlist; cnt=((int)s)-1; a=q[0].name; if(cnt>0){ a=cat(a,\" and \", cnt, \" more\");}  return cat(a, \" versus \", s[0].name);" });
            }
        }
        if (elem.name.indexOf(".referenceAnnot") > 0) {
            var annots = algoProcess.getValue("referenceAnnot", "join");
            algoProcess.setValueList({ referenceAnnotTypes: "ajax:ionAnnotTypes&fromComputation=0&ionObjs=" + annots, change: 'constraint' });

        }
        if (node && elem.name.indexOf(".alignSelector") > 0) {
            // reload page with new cmdMode if it changed
            var md = docLocValue("cmdMode")
            var new_url = urlExchangeParameter("" + document.location, "cmdMode", node.name + (modeIndex < 0 ? "" : md.substring(modeIndex)));
            new_url = urlExchangeParameter(new_url, "version", node.version);
            document.location = new_url;
        }
        algoProcess.inputLoaded(viewer, elem);
    }


    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    gInitList += "hexagonInit();";
    async function hexagonInit() {
        var topVal = $("#header").height() + 45;
        //$(".content").attr("style", "top: "+ topVal +"px; ");

        // wait for DS callbacks
        var i = 0;
        while (!isDsReloaded && i < 10) {
            await sleep(1000)
            i++;
        }

        globalAlgo = $('#mainAlgoArea').algoview({
            algoObj: algoProcess,
            svcType: !isMultipleAlignment ? 'svc-align2' : 'svc-align-multiple2',
            algoTitle: algoTitle
        });
        setLocationTitle(algoTitle + " - HIVE");

        isDsReloaded = false;
    };

</script>
